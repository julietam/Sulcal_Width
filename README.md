# Sulcal_Width
A two-stage pipeline to calculate sulcal width metrics based on FreeSurfer processed T1-w MRI data. Implements the method described in Mateos et al., NeuroImage, 207:116343 (2020).


## Overview

The pipeline is divided into two main stages:

1.  **Stage A: Generate Intermediate Volumes (`StageA_GenerateVolumes2.m`)**
    * Takes FreeSurfer outputs as input (specifically `mri/brain.nii` and `labels/*.label.nii`).
    * Generates necessary intermediate files for each subject within their respective FreeSurfer output directory:
        * Anisotropic distance map (`Brain_distmap_anisotropic.raw`, `.nii`)
        * Morphological brain closure (`brain_closing.raw`, `.nii`)
        * Masked distance map (`Brain_masked_distmap_anisotropic.raw`)
        * Local maxima map (`localmax_Brain_distmap_anisotropic.raw`, `.nii`) using the `RegionGrowing24` tool.
        * Combined and dilated sulcal label maps (`Brain_sulci.raw`, `.nii`, `sulci_dil.raw`, `.nii`).
    * *Note:* This script uses specific permutations (`permute([2 1 3]`) when saving/loading raw files.

2.  **Stage B: Calculate Mean Sulci Metrics (`StageB_CalculateMetrics.m`)**
    * Loads the intermediate volumes generated by Stage A.
    * Calculates a modified local maxima map (`localmax_mod`).
    * Computes the mean `localmax_mod` value within each dilated sulcal label region.
    * Calculates the count of local maxima voxels overlapping with each sulcal label.
    * Saves a per-subject backup file containing both mean metrics and counts (`<SubjectID>_sulci_metrics_counts_backup.txt`).
    * Appends the **mean metrics only** for each subject to a central CSV file (`summary_sulci_metrics_MEAN_v3.csv`).

## Requirements

* **MATLAB:** Including the Image Processing Toolbox (for functions like `imclose`, `imdilate`, `strel`, `bwdistsc`, `imbinarize`).
* **FreeSurfer:** Requires the output directory structure from FreeSurfer `recon-all`. Specifically needs:
    * `<subject_dir>/mri/brain.nii`
    * `<subject_dir>/mri/ribbon.nii` (used by helper functions)
    * `<subject_dir>/labels/*.label.nii` (label files generated by FreeSurfer)
    * `mri_convert` tool from FreeSurfer needs to be in the system's PATH or its path specified in `StageA_GenerateVolumes2.m`.
* **NIfTI MATLAB Toolbox:** Required for reading/writing NIfTI files (`niftiread`, `niftiinfo`, `niftiwrite`). The path needs to be configured in `StageA_GenerateVolumes2.m` and `StageB_CalculateMetrics.m`.
* **bwdistsc MATLAB function:** A custom function for anisotropic distance transform seems to be used. Ensure this function is available and its path is configured in `StageA_GenerateVolumes2.m`. (If using MATLAB's standard `bwdist`, update the script).
* **RegionGrowing24 Executable:** A separate executable tool for finding local maxima. You need to obtain or compile this tool and configure its path (`config.rg24Path`) in `StageA_GenerateVolumes2.m`.
* **(Optional) Cluster Environment:** The provided `submit_*.sh` scripts are designed for a Sun Grid Engine (SGE) cluster. Using these requires:
    * An SGE (or similar DRMAA-compliant) scheduler.
    * A shared filesystem accessible by compute nodes where FreeSurfer outputs and scripts reside.

## Setup

1.  **Clone Repository:**
    ```bash
    git clone <your-repository-url>
    cd <your-repository-directory>
    ```
2.  **Configure MATLAB Scripts:**
    * Edit `StageA_GenerateVolumes2.m`:
        * Set `config.rootFolder` to the base directory containing your FreeSurfer subject output folders.
        * Verify/Set paths for `config.niftiToolsPath`, `config.bwdistscPath`, `config.helperScriptsPath`, `config.rg24Path`.
        * Ensure `config.mriConvertPath` points to your `mri_convert` or is callable from the command line.
        * Adjust `config.imageSize` if your data differs from [256, 256, 256].
        * Adjust processing parameters (`config.closingRadius`, `config.rg24Directions`, `config.sulciDilateRadius`) if needed.
    * Edit `StageB_CalculateMetrics.m`:
        * Set `config.rootFolder` to the same base directory as in Stage A.
        * Verify/Set `config.outputSummaryFile` path where the final results CSV will be written.
        * Ensure `config.imageSize` matches Stage A.
        * Set `config.maxExpectedLabels` to the maximum label number expected (e.g., 68).
        * Verify/Set paths for `config.helperScriptsPath` and `config.niftiToolsPath` if not running compiled MATLAB.

3.  **Prepare Subject List:**
    * Create a text file named `subject_list.txt` in the location specified by `SCRIPT_DIR` in the submission scripts.
    * List one FreeSurfer subject ID per line. These IDs should correspond to the folder names within your `config.rootFolder`.

4.  **Configure Submission Scripts (if using a cluster):**
    * Edit `submit_stage_A.sh` and `submit_stage_B.sh`:
        * **SGE Options:** Adjust `#$` options (`-l h_rt`, `-l h_vmem`, `-pe smp`, `-t 1-N`) for your cluster environment and the number of subjects (N should match the number of lines in `subject_list.txt`).
        * **Paths:** Set `SCRIPT_DIR` to the directory containing the `.m` scripts and `subject_list.txt`. Set `LOG_DIR` to your desired log location. Set `MATLAB_CMD` to the full path of your MATLAB executable.
        * **MATLAB Module:** Uncomment and adapt the `module load matlab/...` line if required on your cluster.
        * **(Stage B Only)**: **Crucially**, edit the `-hold_jid <StageA_JobID>` line in `submit_stage_B.sh`. After submitting Stage A, replace `<StageA_JobID>` with the actual job ID returned by the scheduler (e.g., `-hold_jid 12345`). This ensures Stage B only runs after Stage A is complete.

## Usage

### Input Data Structure

Ensure your data is organized as follows:

<config.rootFolder>/
└── <SubjectID_1>/             # FreeSurfer output directory
├── mri/
│   ├── brain.nii       # Essential input for Stage A
│   └── ribbon.nii      # Used by helper functions
├── labels/
│   ├── lh..label.nii  # Example label file needed by Stage A
│   └── rh..label.nii  # Example label file needed by Stage A
└── (other FreeSurfer directories/files)
└── <SubjectID_2>/
└── ...
└── ...


### Running the Pipeline (Cluster Example using SGE)

1.  **Submit Stage A:**
    ```bash
    qsub submit_stage_A.sh
    ```
    Note the Job ID returned (e.g., `Your job-array 12345.1-N ("BrainPipe_StageA") has been submitted`).

2.  **Update Stage B Dependency:**
    * Edit `submit_stage_B.sh`.
    * Replace `<StageA_JobID>` with the Job ID from step 1 (e.g., `-hold_jid 12345`).

3.  **Submit Stage B:**
    ```bash
    qsub submit_stage_B.sh
    ```
    Stage B jobs will wait until the corresponding Stage A tasks are finished.

### Running Manually (Single Subject Example)

You can adapt the MATLAB scripts to run for a single subject without a cluster:

1.  **Modify `StageA_GenerateVolumes2.m`:**
    * Comment out or remove `datasetID = getenv('JOB_SUBJECT_ID');`.
    * Hardcode a subject ID: `datasetID = 'YourSubjectID';`.
    * Comment out the final `exit(0);` and `exit(1);` lines if running interactively.
    * Run the script in MATLAB.

2.  **Modify `StageB_CalculateMetrics.m`:**
    * Apply the same changes as for Stage A (set `datasetID`, remove `exit` calls).
    * Run the script in MATLAB *after* Stage A has successfully completed for that subject.

### Output

* **Intermediate files:** Stored within each subject's directory.
* **Per-subject backup:** `<SubjectID>_sulci_metrics_counts_backup.txt` within each subject's directory.
* **Main Result:** A CSV file (default: `summary_sulci_metrics_MEAN_v3.csv`) located in `config.rootFolder`, containing the mean sulcal width metrics for all processed subjects. The first column is the `DatasetID`, followed by columns `Sulcus_1`, `Sulcus_2`, ..., up to `Sulcus_<maxExpectedLabels>`.

## File Descriptions

* `StageA_GenerateVolumes2.m`: MATLAB script for Stage 1 - generates intermediate volumes.
* `StageB_CalculateMetrics.m`: MATLAB script for Stage 2 - calculates metrics and appends to summary file.
* `submit_stage_A.sh`: Example SGE batch submission script for Stage A.
* `submit_stage_B.sh`: Example SGE batch submission script for Stage B, with dependency on Stage A.
* `subject_list.txt` (User-created): Text file listing subject IDs, one per line.

## License

MIT

## Citation

If you use this pipeline in your research, please cite the following publication:

Mateos MJ, Gastelum-Strozzi A, Barrios FA, Bribiesca E, Alcauter S, Marquez-Flores JA. A novel voxel-based method to estimate cortical sulci width and its application to compare patients with Alzheimer’s disease to controls. *NeuroImage*. 2020 Feb 15;207:116343. doi: 10.1016/j.neuroimage.2019.116343. Epub 2019 Nov 21. PMID: 31759047.
